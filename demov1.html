<html>

<head>
    <title>Stardog Demo</title>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/prop-types@15.6.2/prop-types.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
    <script src="js/stardog.min.js"></script>
    <script src="js/lodash.js"></script>


    <script src="js/d3.v5.js"></script>
    <script src="js/d3Test.js"></script>

    <script>
        const standConn = new stardogjs.Connection({
            username: 'admin',
            password: 'admin',
            endpoint: 'http://localhost:5820',
        });

        const graphQLConn = new stardogjs.Connection({
                username: 'admin',
                password: 'admin',
                endpoint: 'http://localhost:5820',
            },
            {
                createHeaders: ({headers}) => {
                    // headers.set('Connection', 'keep-alive');
                    // headers.set('Transfer-Encoding', 'chunked');
                    headers.set('Content-Type', 'application/json');
                    return headers;
                }
            }
        );

        window.onload = () => {
            stardogjs.db.create(standConn, 'stardogDemo').then(({body}) => {
                let queryStr = 'insert data {\n' +
                    '    :linkType a owl:ObjectProperty .\n' +
                    '    :motherOf rdfs:subPropertyOf :linkType .\n' +
                    '    :fatherOf rdfs:subPropertyOf :linkType .\n' +
                    '    :husbandOf rdfs:subPropertyOf :linkType .\n' +
                    '    :wifeOf rdfs:subPropertyOf :linkType .\n' +
                    '    :sisterOf rdfs:subPropertyOf :linkType .\n' +
                    '    :brotherOf rdfs:subPropertyOf :linkType .\n' +
                    '    :friendOf rdfs:subPropertyOf :linkType .\n' +
                    '    :cousinOf rdfs:subPropertyOf :linkType .\n' +
                    '    :uncleOf rdfs:subPropertyOf :linkType .\n' +
                    '    :auntOf rdfs:subPropertyOf :linkType .\n' +
                    '}';
                stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json', {reasoning: false}).then(({body}) => {

                });
            });
        };

        var node, link, simulation;
    </script>

    <link rel="stylesheet" type="text/css" href="css/style_1.css">
    <link rel="stylesheet" type="text/css" href="css/tabs.css">
</head>

<body>
<div id="root"></div>
<script type="text/babel">

    const rootElement = document.getElementById('root');

    class QueryEditor extends React.Component {
        state = {queryTxt: ''};

        handleClick = () => {
            this.props.runQuery(this.state.queryTxt)
        };

        onChange = (ev) => {
            this.setState({queryTxt: ev.target.value})
        };

        render() {
            return (
                <div>
                    <div>
                        <textarea onChange={this.onChange} value={this.state.queryTxt} />
                    </div>
                    <div style={{marginTop: '5px', textAlign: 'right'}}>
                        <button onClick={this.handleClick}>
                            Execute Query
                        </button>
                    </div>
                </div>
            )
        }
    }

    QueryEditor.propTypes = {
        runQuery: PropTypes.func.isRequired
    };

    class ResultPane extends React.Component {
        constructor(props) {
            super(props);
        }

        render() {
            return (
                <div style={{marginTop: '20px'}}>
                    <div>
                        <textarea value={this.props.queryResult} />
                    </div>
                </div>
            )
        }
    }

    ResultPane.propTypes = {
        queryResult: PropTypes.string.isRequired
    };
    ResultPane.defaultProps = {
        queryResult: ''
    };

    class AddPerson extends React.Component {
        constructor(props) {
            super(props);

            this.error = "Please fill in both the First and Last name."
        }

        state = {
            firstName: '',
            lastName: '',
            showError: false
        };

        handleEnterClick = (e) => {
            if (e.keyCode === 13) {
                this.handleClick();
            }
        };

        handleClick = () => {
            if (this.state.firstName && this.state.lastName) {
                this.setState({
                    showError: false
                });
                this.props.addPerson({firstName: this.state.firstName.trim(), lastName: this.state.lastName.trim()});
            } else {
                this.setState({showError: true});
            }
        };

        updateFNState = (ev) => {
            this.setState({firstName: ev.target.value});
        };

        updateLNState = (ev) => {
            this.setState({lastName: ev.target.value});
        };

        componentDidUpdate() {
            if (this.props.clearForm && (this.state.firstName !== '' || this.state.lastName !== '')) {
                this.setState({
                    firstName: '',
                    lastName: '',
                });
            }
        }

        render() {
            return (
                <div>
                    <div>Add Person</div>
                    <div className="consoleBorder personForm">
                        <div>
                            <div className="labelColumn">First Name:</div>
                            <div className="inputColumn">
                                <input type="text" value={this.state.firstName} onKeyDown={this.handleEnterClick} onChange={this.updateFNState}/>
                            </div>
                        </div>
                        <div>
                            <div className="labelColumn">Last Name:</div>
                            <div className="inputColumn">
                                <input type="text" value={this.state.lastName} onKeyDown={this.handleEnterClick} onChange={this.updateLNState}/>
                            </div>
                        </div>
                        {this.state.showError && <div className="error">{this.error}</div>}
                        <div className="personAddBtn">
                            <button onClick={this.handleClick}>
                                Add Person
                            </button>
                        </div>
                    </div>
                </div>
            )
        }
    }

    AddPerson.propTypes = {
        addPerson: PropTypes.func.isRequired,
        clearForm: PropTypes.bool
    };

    class AddRelationship extends React.Component {
        constructor(props) {
            super(props);

            this.allDataError = "Please select a 'From Person', 'Relationship', and 'To Person'.";
            this.samePerson = "Please select a different 'To Person' than the 'From Person'.";


            this.state = {
                personOptions: [],
                edgeOptions: [],
                fromPerson: '',
                toPerson: '',
                relationship: '',
                error: '',
                showError: false
            };
        }

        componentDidMount() {
            stardogjs.query.graphql.execute(graphQLConn, 'stardogDemo',
                'query ' +
                '   withAliases @config(alias: {person: "http://api.stardog.com/Person"}) {' +
                '       person {' +
                '           firstName: stardog_firstName,' +
                '           lastName: stardog_lastName ' +
                '       }' +
                '   }',
                {
                    "@reasoning": true
                }
            ).then(({body}) => {
                if (body && body.data.length > 0) {

                    let newOptions = [];
                    body.data.forEach(p => {
                        newOptions.push(<option key={`${p.firstName}_${p.lastName}`} value={`${p.firstName}_${p.lastName}`}>{`${p.firstName} ${p.lastName}`}</option>);
                    });

                    this.setState({personOptions: newOptions})
                }

            }).catch((err) => {
                return Promise.reject(err);
            });

            let queryStr = 'select ?linkType where { \n' +
                '    ?linkType rdfs:subPropertyOf :linkType . \n' +
                '}';
            stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json', {reasoning: false}).then(({body}) => {
                if (body && body.results && body.results.bindings && body.results.bindings.length > 0) {
                    let newOptions = [];
                    body.results.bindings.forEach(p => {
                        let relationship = p.linkType.value.substring(p.linkType.value.lastIndexOf('/') + 1, p.linkType.value.length);
                        newOptions.push(<option key={relationship} value={relationship}>{relationship}</option>);
                    });

                    this.setState({edgeOptions: newOptions})
                }
            });
        }

        handleClick = () => {
            if (!this.state.fromPerson || !this.state.toPerson || !this.state.relationship) {
                this.setState({
                    error: this.allDataError,
                    showError: true
                });
            } else if (this.state.fromPerson === this.state.toPerson) {
                this.setState({
                    error: this.samePerson,
                    showError: true
                });
            } else {
                this.setState({
                    error: '',
                    showError: false
                });

                this.props.addRelationship({fromPerson: this.state.fromPerson, toPerson: this.state.toPerson, relationship: this.state.relationship})
            }

        };

        handleFrom = (ev) => {
            this.setState({
                fromPerson: `<http://stardog.com/${ev.target.value}>`
            });
        };

        handleTo = (ev) => {
            this.setState({
                toPerson: `<http://stardog.com/${ev.target.value}>`
            });
        };


        handleRelationship = (ev) => {
            this.setState({
                relationship: `:${ev.target.value}`
            });
        };

        render() {
            return (
                <div>
                    <div>Add Relationship</div>
                    <div className="consoleBorder relationshipForm">
                        <div style={{display: 'inline-block', paddingRight: '10px', verticalAlign: 'top'}}>
                            <div className="labelRow">From Person:</div>
                            <div className="inputColumn">
                                <select name="fromPerson" multiple className="personSelect" onClick={this.handleFrom}>
                                    {this.state.personOptions}
                                </select>
                            </div>
                        </div>
                        <div style={{display: 'inline-block', paddingRight: '10px', verticalAlign: 'top'}}>
                            <div className="labelRow">Relationship:</div>
                            <div className="inputColumn">
                                <select style={{width: '150px'}} onChange={this.handleRelationship}>
                                    <option value="" />
                                    {this.state.edgeOptions}
                                </select>
                            </div>
                        </div>
                        <div style={{display: 'inline-block', verticalAlign: 'top'}}>
                            <div className="labelRow">To Person:</div>
                            <div className="inputColumn">
                                <select name="toPerson" multiple className="personSelect" onClick={this.handleTo}>
                                    {this.state.personOptions}
                                </select>
                            </div>
                        </div>
                        {this.state.showError && <div className="error">{this.state.error}</div>}
                        <div className="personAddBtn">
                            <button onClick={this.handleClick}>
                                Add Relationship
                            </button>
                        </div>
                    </div>
                </div>
            )
        }
    }

    AddRelationship.propTypes = {
        addRelationship: PropTypes.func.isRequired,
    };

    class GraphView extends React.Component {
        constructor(props) {
            super(props);
        }

        componentDidUpdate() {
            this.performQuery();
        }

        componentDidMount() {
            this.performQuery();
        }

        performQuery() {
            let nodes = {}, edges = {};

            stardogjs.query.graphql.execute(graphQLConn, 'stardogDemo',
                'query \n' +
                '   withAliases @config(alias: {person: "http://api.stardog.com/Person"}) {\n' +
                '       person {\n' +
                '           firstName: stardog_firstName,\n' +
                '           lastName: stardog_lastName,\n' +
                '           id @bind(to : "CONCAT($firstName, \'_\', $lastName)")\n' +
                '       }\n' +
                '   }',
                {
                    "@reasoning": false
                }
            ).then(({body}) => {
                if (body && body.data.length > 0) {
                    nodes = body.data;
                }

                let queryStr = 'select ?source ?target ?linkType where { \n' +
                    '    ?linkType rdfs:subPropertyOf :linkType . \n' +
                    '    ?s ?linkType ?t .\n' +
                    '    ?s stardog:firstName ?sfn .\n' +
                    '    ?s stardog:lastName ?sln .\n' +
                    '    ?t stardog:firstName ?tfn .\n' +
                    '    ?t stardog:lastName ?tln .\n' +
                    '    BIND (concat (?sfn, \'_\', ?sln) AS ?source) .\n' +
                    '    BIND (concat (?tfn, \'_\', ?tln) AS ?target) .\n' +
                    '}';
                stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json', {reasoning: false}).then(({body}) => {
                    if (body && body.results && body.results.bindings && body.results.bindings.length > 0) {
                        edges = body.results.bindings;
                    }

                    this.updateGraph(nodes, edges);
                });

            }).catch((err) => {
                return Promise.reject(err);
            });

        }

        updateGraph(nodes, edgesSparql) {

            let edges = [];
            if (!_.isEmpty(edgesSparql)) {
                edgesSparql.forEach(e => {
                    edges.push({
                        "source": e.source.value,
                        "target": e.target.value,
                        "linkType": e.linkType.value
                    })
                });
            }

            d3.select("svg").selectAll("*").remove();

            // d3.select("svg")
            //     .call(d3.zoom()
            //         .scaleExtent([1 / 2, 4])
            //         .on("zoom", zoomed));
            //
            // d3.select('svg').call(d3.drag()
            //     .on("start", dragstarted)
            //     .on("drag", dragged)
            //     .on("end", dragended));

            if (edges.length > 0) {
                simulation = d3.forceSimulation(nodes)
                    .velocityDecay(0.2)
                    .force("collide", d3.forceCollide().radius(40).strength(.6))
                    // .force("charge", d3.forceManyBody())
                    .force("center", d3.forceCenter((window.innerWidth - 100) / 2, 250))
                    .force("link", d3.forceLink().distance(100).id(function (d) {
                        return d.id;
                    }))
            } else {
                simulation = d3.forceSimulation(nodes)
                    .force("charge", d3.forceManyBody())
                    .force("center", d3.forceCenter((window.innerWidth - 100) / 2, 250));
            }

            link = d3.select("svg")
                .append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(edges)
                .enter()
                .append("path")
                .attr("stroke-width", 2)
                .attr('fill', 'none')
                .attr('stroke-opacity', '1')
                .attr('stroke', 'rgb(221, 221, 221)')
                // .on("mouseover", function (d) {
                //     d3.select(this)
                //         .style("fill", d3.select(this).attr('stroke'))
                //         .attr('class', 'overlay')
                //         .append('title').text(d.linkType);
                // })
                // .on("mouseout", function (d) {
                //     d3.select(this).style("fill", "none").attr('class', 'links');
                // });

            node = d3.select("svg")
                .append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter()
                .append('g')
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            simulation
                .nodes(nodes)
                .on("tick", ticked);

            if (edges.length > 0) {
                simulation.force("link")
                    .links(edges);
            }

            node.append("circle")
                .attr("r", 20)
                .style("fill", "lavender")
                .style("stroke", "black")
                .style("stroke-width", "1px")
                .on("mouseenter", function (d) {
                    d3.select(this).append('title').text(d.id);
                });

            node.append('text')
                .text((d) => {
                    return `${d.firstName} ${d.lastName}`
                })
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'middle');
        }

        shouldComponentUpdate(nextProps, nextState) {
            return !!nextProps.shouldUpdate;
        }

        render() {
            return (
                <div style={{marginTop: '10'}}>
                    <div>Graph View</div>
                    <div className="consoleBorder" id={'graphView'}>
                        <div id="vizcontainer">
                            <svg style={{width: '100%', height: '500px'}} />
                        </div>
                    </div>
                </div>
            )
        }
    }

    GraphView.propTypes = {
        shouldUpdate: PropTypes.bool
    };
    GraphView.defaultProps = {
        shouldUpdate: false
    };


    class Body extends React.Component {
        constructor(props) {
            super(props);
        }

        state = {queryResult: '', response: null, clearForm: false};

        runQuery = (queryStr) => {
            stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json', {
                limit: 10,
                offset: 0,
            }).then(({body}) => {
                this.setState({queryResult: body.results.bindings})
            });
        };

        addPerson = (person) => {
            let queryStr = `insert data { <http://stardog.com/${person.firstName}_${person.lastName}> stardog:firstName '${person.firstName}' ;
                    rdf:type :Person ;
                    stardog:lastName '${person.lastName}' . }`;

            stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json').then(({body}) => {
                if (body) {
                    this.setState({response: body});
                    setTimeout(() => this.setState({response: ''}), 3000);
                } else {
                    this.setState({response: {code: 'Insert Successful', message: 'Insert Successful'}});
                    setTimeout(() => this.setState({response: '', clearForm: true}), 1000);
                }
            });
        };

        addRelationShip = (data) => {
            let queryStr = `insert data { ${data.fromPerson} ${data.relationship} ${data.toPerson} }`;

            stardogjs.query.execute(standConn, 'stardogDemo', queryStr, 'application/sparql-results+json').then(({body}) => {
                if (body) {
                    this.setState({response: body});
                    setTimeout(() => this.setState({response: ''}), 3000);
                } else {
                    this.setState({response: {code: 'Insert Successful', message: 'Insert Successful'}});
                    setTimeout(() => this.setState({response: '', clearForm: true}), 1000);
                }
            });
        };

        componentDidUpdate() {
            if (this.state.clearForm === true) {
                this.setState({clearForm: false});
            }
        }

        shouldComponentUpdate(nextProps, nextState) {
            return this.props.tabIndex !== nextProps.tabIndex
                || this.state.response !== nextState.response
                || this.state.clearForm !== nextState.clearForm;
        }

        render() {
            let content;
            if (this.props.tabIndex === 0) {
                content = (<div>
                    <AddPerson addPerson={this.addPerson} clearForm={this.state.clearForm} />
                    <GraphView shouldUpdate={this.state.clearForm}/>
                </div>);
            } else if (this.props.tabIndex === 1) {
                content = (<div>
                    <AddRelationship addRelationship={this.addRelationShip}/>
                    <GraphView shouldUpdate={this.state.clearForm}/>
                </div>);
            } else if (this.props.tabIndex === 2) {
                content = (
                    <div>
                        <div><QueryEditor runQuery={this.runQuery}/></div>
                        <div><ResultPane queryResult={this.state.queryResult}/></div>
                    </div>);
            }

            return (<div>{this.state.response && <Modal response={this.state.response}/>}{content}</div>);
        }
    }

    Body.propTypes = {
        tabIndex: PropTypes.number.isRequired
    };

    class Modal extends React.Component {
        render() {
            return (
                <div id="myModal" className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <p>{this.props.response.code}</p>
                        </div>
                        <div className="modal-body">
                            <p>{this.props.response.message}</p>
                        </div>
                    </div>
                </div>);
        }
    }

    Modal.propTypes = {
        response: PropTypes.object.isRequired
    };
    Modal.defaultProps = {
        response: ''
    };

    class Console extends React.Component {
        constructor(props) {
            super(props);
        }

        state = {tabIndex: 0, showModal: false};

        updateTabIndex(value) {
            this.setState({tabIndex: value})
        };

        showModal = () => {
            this.setState({ showModal: true });
        };

        hideModal = () => {
            this.setState({ showModal: false });
        };

        render() {
            return (
                <div>
                    <Header />
                    <div className="console">
                        <div className="tabContent">
                            <div onClick={this.updateTabIndex.bind(this, 0)} className={this.state.tabIndex === 0 ? 'tab tabOn' : 'tab'}>Add Person</div>
                            <div onClick={this.updateTabIndex.bind(this, 1)} className={this.state.tabIndex === 1 ? 'tab tabOn' : 'tab'}>Add Relationship</div>
                            <div style={{display: 'none'}} onClick={this.updateTabIndex.bind(this, 2)} className={this.state.tabIndex === 2 ? 'tab tabOn' : 'tab'}>Query Editor</div>
                            <div style={{display: 'inline', float: 'right', margin: '3px', cursor: 'pointer'}} onClick={this.showModal}>
                                <img alt="" src={'images/Info_Simple.svg'} style={{height: '25px'}}/>
                                <span style={{paddingLeft: '5px', top: '1px', position: 'relative'}}>Query Information</span>
                            </div>
                        </div>
                        <div className="consoleBody">
                            <Body tabIndex={this.state.tabIndex}/>
                        </div>
                    </div>
                    <Footer />
                    <InfoModal show={this.state.showModal} handleClose={this.hideModal} />
                </div>
            );
        }
    }

    class Header extends React.PureComponent {
        render() {
            return (
                <div className="topbarmenu" id="home">
                    <div className="preheader">
                        <div className="row" id="top-navigation">
                            <div className="large-4 medium-6 small-9 column">
                                <div className="mascot">
                                    <a href="http://www.stardog.com">
                                        <img src="images/stardog-logo.png"
                                             alt="Stardog logo" /></a>
                                </div>
                                <div className="stardog-name">
                                    <a href="http://www.stardog.com" title="Stardog—The Knowledge Graph Platform for the Enterprise">
                                        STARDOG
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            );
        }
    }

    class Footer extends React.PureComponent {
        render() {
            return (
                <section className="copyright">
                    <div className="row">
                        <div className="small-12 column">
                            <p>© <span id="year">2018</span> Stardog Union · All Rights Reserved. <a href="https://www.stardog.com/pp.html" target="_blank" className="mt20">Privacy Policy</a>.</p>
                        </div>
                    </div>
                </section>
            );
        }
    }

    const InfoModal = ({ handleClose, show }) => {
        const showHideClassName = show ? "modal display-block" : "modal display-none";

        const graphQLCall = 'query \n' +
            '  withAliases @config(alias: {person: "http://api.stardog.com/Person"}) {\n' +
            '    person {\n' +
            '      firstName: stardog_firstName,\n' +
            '      lastName: stardog_lastName,\n' +
            '      id @bind(to : "CONCAT($firstName, \'_\', $lastName)")\n' +
            '   }\n' +
            '  }';

        const sparqlCall = 'select ?source ?target ?linkType where { \n' +
            '    ?linkType rdfs:subPropertyOf :linkType . \n' +
            '    ?s ?linkType ?t .\n' +
            '    ?s stardog:firstName ?sfn .\n' +
            '    ?s stardog:lastName ?sln .\n' +
            '    ?t stardog:firstName ?tfn .\n' +
            '    ?t stardog:lastName ?tln .\n' +
            '    BIND (concat (?sfn, \'_\', ?sln) AS ?source) .\n' +
            '    BIND (concat (?tfn, \'_\', ?tln) AS ?target) .\n' +
            '}';

        return (
            <div className={showHideClassName}>
                <div className="modal-main">
                    <div className={'tab tabOn modalHeader'}>
                        Query Information
                    </div>
                    <div style={{margin: '15px'}}>
                        In order to use our data with d3, we need to query for both the nodes and edges that
                        we want to display. We will use the latest version of stardogJS and execute both GraphQL
                        and SPARQL queries. GraphQL is highly recommended with the use of d3 as it can return
                        a JSON object exactly as you need it. In some instances, as for getting the edges, we will
                        need to perform a regular SPARQL query and convert it to the JSON we want.

                        <div style={{margin: '15px 0', border: '1px solid #112d36'}}>
                            <div className={'tab modalHeader'} style={{borderBottom: '1px solid #112d36'}}>Nodes</div>
                            <div style={{padding: `6px 12px`}}>
                                <div>
                                    We use Stardog's GraphQL interface in order to pull back the list of nodes. We
                                    get the Person's first name, last name, and their ID as an ID is needed by d3
                                    in order to attached the edges to the specific nodes.
                                </div>
                                <div>
                                        <pre>
                                            <code>
                                                {graphQLCall}
                                            </code>
                                        </pre>
                                </div>
                            </div>
                        </div>
                        <div style={{margin: '15px 0', border: '1px solid #112d36'}}>
                            <div className={'tab modalHeader'} style={{borderBottom: '1px solid #112d36'}}>Edges</div>
                            <div style={{padding: `6px 12px`}}>
                                <div>
                                    We use Stardog's SPARQL interface in order to pull back the list of edges. In
                                    the query, we get all the Predicates that are of rdfs:subPropertyOf of :linkType.
                                    In addition, we have to create both the source and the target using the Person's
                                    first and last name in order to create the ID that is used in the list of nodes.

                                </div>
                                <div>
                                        <pre>
                                            <code>
                                                {sparqlCall}
                                            </code>
                                        </pre>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div style={{borderTop: '1px solid #112d36', width: '100%'}}>
                        <div style={{margin: '10px', float: 'right'}}>
                            <button onClick={handleClose}>Close</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    ReactDOM.render(<Console />, rootElement)
</script>

</body>

</html>